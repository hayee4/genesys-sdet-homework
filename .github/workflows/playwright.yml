name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false
  
jobs:
  api-tests:
    name: Run API Tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run API tests
      run: npx playwright test --grep "@api" --project=api-tests

    - name: Upload API test report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: api-test-report
        path: playwright-report/
        retention-days: 30

  e2e-tests:
    name: Run E2E Tests (${{ matrix.browser }})
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: api-tests
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      
    - name: Run E2E tests on ${{ matrix.browser }}
      run: npx playwright test --grep "@e2e" --project=${{ matrix.browser }}

    - name: Upload E2E test report (${{ matrix.browser }})
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: e2e-test-report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30

  combine-reports:
    name: Combine Test Reports
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests]
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Download API test report
      uses: actions/download-artifact@v4
      with:
        name: api-test-report
        path: api-report/

    - name: Download E2E test reports (all browsers)
      uses: actions/download-artifact@v4
      with:
        pattern: e2e-test-report-*
        path: e2e-reports/
        merge-multiple: true
        
    - name: Prepare combined Pages site
      run: |
          mkdir -p site/${{ github.run_number }}/api
          mkdir -p site/${{ github.run_number }}/e2e
          
          # Copy API report
          if [ -d "api-report" ]; then
            cp -r api-report/* site/${{ github.run_number }}/api/
          fi
          
          # Copy E2E reports 
          if [ -d "e2e-reports" ]; then
            cp -r e2e-reports/* site/${{ github.run_number }}/e2e/
          fi
          
          # Create navigation index
          cat > site/${{ github.run_number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Test Reports - Run ${{ github.run_number }}</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .report-link { display: block; padding: 20px; margin: 10px 0; 
                                background: #f5f5f5; text-decoration: none; 
                                border-radius: 5px; color: #333; }
                  .report-link:hover { background: #e0e0e0; }
                  h1 { color: #333; }
                  .browsers { font-size: 0.9em; color: #666; }
              </style>
          </head>
          <body>
              <h1>Playwright Test Reports - Run ${{ github.run_number }}</h1>
              <a href="api/" class="report-link">
                  <strong>ğŸ“¡ API Tests Report</strong><br>
                  View API test results and coverage
              </a>
              <a href="e2e/" class="report-link">
                  <strong>ğŸŒ E2E Tests Report</strong><br>
                  <span class="browsers">Cross-browser results: Chrome, Firefox, Safari</span><br>
                  View end-to-end test results and screenshots
              </a>
          </body>
          </html>
          EOF
          
          # Main redirect to latest run
          echo "<meta http-equiv='refresh' content='0; url=${{ github.run_number }}/'>" > site/index.html

    - name: Upload combined Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: site

  deploy:
    name: Deploy report to GitHub Pages
    if: github.event_name == 'push'
    needs: combine-reports
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
