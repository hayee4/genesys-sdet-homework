name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false
  
jobs:
  api-tests:
    name: Run API Tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run API tests
      run: npx playwright test --grep "@api" --project=api-tests

    - name: Upload API test report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: api-test-report
        path: playwright-report/
        retention-days: 30

  e2e-tests:
    name: Run E2E Tests (${{ matrix.browser }})
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: api-tests
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Get Playwright version
      id: playwright-version
      run: echo "version=$(npm list @playwright/test --depth=0 --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT
      
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
        
    - name: Install Playwright Browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps
      
    - name: Install Playwright Browser Dependencies
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: npx playwright install-deps
      
    - name: Run E2E tests on ${{ matrix.browser }}
      run: npx playwright test --grep "@e2e" --project=${{ matrix.browser }}

    - name: Upload E2E test report (${{ matrix.browser }})
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: e2e-test-report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30

  combine-reports:
    name: Combine Test Reports
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-tests]
    if: always()
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'

    - name: Download API test report
      uses: actions/download-artifact@v4
      with:
        name: api-test-report
        path: api-report/

    - name: Download E2E test reports (Chromium)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: e2e-test-report-chromium
        path: e2e-chromium-report/

    - name: Download E2E test reports (Firefox)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: e2e-test-report-firefox
        path: e2e-firefox-report/

    - name: Download E2E test reports (WebKit)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: e2e-test-report-webkit
        path: e2e-webkit-report/
        
    - name: Prepare combined Pages site
      run: |
          mkdir -p site/${{ github.run_number }}/api
          mkdir -p site/${{ github.run_number }}/e2e/chromium
          mkdir -p site/${{ github.run_number }}/e2e/firefox
          mkdir -p site/${{ github.run_number }}/e2e/webkit
          
          # Copy API report
          if [ -d "api-report" ]; then
            cp -r api-report/* site/${{ github.run_number }}/api/
          fi
          
          # Copy each browser report to separate folders
          if [ -d "e2e-chromium-report" ]; then
            cp -r e2e-chromium-report/* site/${{ github.run_number }}/e2e/chromium/
          fi
          if [ -d "e2e-firefox-report" ]; then
            cp -r e2e-firefox-report/* site/${{ github.run_number }}/e2e/firefox/
          fi
          if [ -d "e2e-webkit-report" ]; then
            cp -r e2e-webkit-report/* site/${{ github.run_number }}/e2e/webkit/
          fi
          
          # Create navigation index
          cat > site/${{ github.run_number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Test Reports - Run ${{ github.run_number }}</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .report-link { display: block; padding: 20px; margin: 10px 0; 
                                background: #f5f5f5; text-decoration: none; 
                                border-radius: 5px; color: #333; }
                  .report-link:hover { background: #e0e0e0; }
                  .browser-reports { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
                  .browser-link { display: block; padding: 15px; background: #e8f4fd; 
                                 text-decoration: none; border-radius: 5px; color: #333; text-align: center; }
                  .browser-link:hover { background: #d1e7dd; }
                  h1 { color: #333; }
                  h2 { color: #666; margin-top: 30px; }
              </style>
          </head>
          <body>
              <h1>Playwright Test Reports - Run ${{ github.run_number }}</h1>
              
              <a href="api/" class="report-link">
                  <strong>ğŸ“¡ API Tests Report</strong><br>
                  View API test results and coverage
              </a>
              
              <h2>ğŸŒ E2E Test Reports by Browser</h2>
              <div class="browser-reports">
                  <a href="e2e/chromium/" class="browser-link">
                      <strong>ğŸŸ¢ Chromium</strong><br>
                      Chrome/Edge tests
                  </a>
                  <a href="e2e/firefox/" class="browser-link">
                      <strong>ğŸŸ  Firefox</strong><br>
                      Gecko engine tests
                  </a>
                  <a href="e2e/webkit/" class="browser-link">
                      <strong>ğŸ”µ WebKit</strong><br>
                      Safari tests
                  </a>
              </div>
          </body>
          </html>
          EOF
          
          # Main redirect to latest run
          echo "<meta http-equiv='refresh' content='0; url=${{ github.run_number }}/'>" > site/index.html

    - name: Upload combined Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: site

  deploy:
    name: Deploy report to GitHub Pages
    if: always() && github.event_name == 'push'
    needs: combine-reports
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
